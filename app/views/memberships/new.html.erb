<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script>
  Stripe.setPublishableKey("<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>");
  var $form = $('#payment-form');
  $(function() {
    $form.submit(function(event) {
      Stripe.card.createToken({
        number: $('.card-number').val(),
        cvc: $('.card-cvc').val(),
        exp_month: $('.card-expiry-month').val(),
        exp_year: $('.card-expiry-year').val()
      }, stripeResponseHandler);
      
      Stripe.bankAccount.createToken({
        country: $('.country').val(),
        currency: $('.currency').val(),
        routing_number: $('.routing-number').val(),
        account_number: $('.account-number').val(),
        account_holder_name: $('.name').val(),
        account_holder_type: $('.account_holder_type').val()
      }, stripeResponseHandler);
      
      function stripeResponseHandler(status, response) {
        // Grab the form:
        if (response.error) { // Problem!
          // Show the errors on the form
          $form.find('.payment-errors').text(response.error.message);
          $form.find('.bank-errors').text(response.error.message);
          $form.find('button').prop('disabled', false); // Re-enable submission
        } else { // Token was created!
          // Get the token ID:
          var token = response.id;
          // Insert the token into the form so it gets submitted to the server:
          $form.append($('<input type="hidden" name="stripeToken" />').val(token));
          // Submit the form:
          $form.get(0).submit();

        }
      }
    });
  });

</script>

<div style='display: flex; flex-direction: column; align-items: center;'>

  <h2>Please select a ZenFit membership plan.</h2>
  
  <%= form_tag memberships_path do %>
    <% if flash[:error].present? %>
      <div id="error_explanation">
        <p><%= flash[:error] %></p>
      </div>
    <% end %>
      
    <article id='payment-plans' style='display: flex; flex-direction: column; align-items: center;'>
      <h3>Upfront Memberships</h3>
      <% @upfront_plans.each do |plan| %>
        <div class='upfront-payment-plan'>
          <input type='radio' name='plan' value=<%= plan.id %>><%= plan.name %></input>
        </div>
      <% end %>
      <h3>Monthly Memberships</h3>
      <% @monthly_plans.each do |plan| %>
        <div class='monthly-payment-plan'>
          <input type='radio' name='plan' value=<%= plan.id %>><%= plan.name %></input>
        </div>
      <% end %>
    </article>
    <br />
    
    <article style='display: flex; flex-direction: row;'>
      <div id='cc-fields' style='padding-right: 10px; border: 1px solid gray;'>
        <h4>Pay with card</h4>
        <div class="form-row">
          <label>
            <span>Card Number</span>
            <input type="text" size="20" data-stripe="number">
          </label>
        </div>
        <div class="form-row">
          <label>
            <span>Expiration (MM/YY)</span>
            <input type="text" size="2" data-stripe="exp_month">
          </label>
          <span> / </span>
          <input type="text" size="2" data-stripe="exp_year">
        </div>
        <div class="form-row">
          <label>
            <span>CVC</span>
            <input type="text" size="4" data-stripe="cvc">
          </label>
        </div>
      </div>
      <div id='ba-fields' style='padding-left: 10px; border: 1px solid gray;'>
        <h4>Pay with bank account</h4>
        <div class="form-row">
          <label>
            <span>Account Holder Name</span>
            <input type="text" size="20" data-stripe="name">
          </label>
        </div>
        <div class="form-row">
          <label>
            <span>Account Number</span>
            <input type="text" size="20" data-stripe="account-number">
          </label>
        </div>
        <div class="form-row">
          <label>
            <span>Routing Number</span>
            <input type="text" size="16" data-stripe="routing-number">
          </label>
        </div>
      </div>
    </article>
    
    <br />
    
    <div style='display: flex; justify-content: center'>
      <input type="submit" class="submit" value="Save Membership">
    </div>
            
  <% end %>
</div>